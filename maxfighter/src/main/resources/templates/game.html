<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>MaxFighter - Batalha</title>

    <style>
        body {
            background: #ececec;
            font-family: "Courier New", monospace;
        }

        .arena {
            width: 1100px;
            margin: 40px auto;
            background: url('/img/tintomax_bg.png');
            background-size: cover;
            background-position: center;
            border: 6px solid #ff7b00;
            box-shadow: 0 0 20px #00000055;
        }

        .ui-top {
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            background: #ff7b00;
            border-bottom: 5px solid blue;
            font-size: 16px;
            font-weight: bold;
            color: white;
        }

        .hp-bar {
            width: 320px;
            height: 20px;
            background: #550000;
            border: 2px solid black;
        }

        .hp-inner {
            height: 100%;
            background: green;
        }

        .sprites {
            height: 330px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding: 20px;
            margin-top: 15px;
        }

        .sprites img {
            width: 230px;
            height: auto;
        }

        /* Preto e branco quando o monstro morre */
        .fainted {
            filter: grayscale(100%) brightness(50%);
            opacity: 0.7;
        }

        /* Marcador de veneno */
        .poison-badge {
            background: purple;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 14px;
            margin-top: 4px;
            display: inline-block;
        }

        .battle-bottom {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background: #f7dcb6;
        }

        .log-box {
            width: 55%;
            background: white;
            border: 6px solid blue;
            padding: 15px;
            font-size: 18px;
            height: 150px;
            overflow-y: auto;
        }

        .moves {
            width: 40%;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 10px;
        }

        .move-btn {
            background: #4b1e00;
            color: white;
            border: 3px solid blue;
            padding: 15px;
            cursor: pointer;
            font-size: 17px;
            font-weight: bold;
            text-align: center;
        }

        .move-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
    </style>
</head>

<body onload="playSelectionSound()">

<div class="arena">

    <!-- TOPO HP -->
    <div class="ui-top">

        <!-- PLAYER -->
        <div>
            HP: <br>
            <div class="hp-bar">
                <div class="hp-inner"
                     th:style="'width:' + (${player.currentHp} * 100 / ${player.maxHp}) + '%'">
                </div>
            </div>
            <span th:text="${player.currentHp}"></span> /
            <span th:text="${player.maxHp}"></span>

            <!-- Poison -->
            <div th:if="${player.poisonTurnsRemaining > 0}">
                <span class="poison-badge"
                      th:text="'Envenenado (' + ${player.poisonDamagePerTurn} + ' por turno)'"></span>
                </div>
        </div>

        <!-- INIMIGO -->
        <div style="text-align:right;">
            HP: <br>
            <div class="hp-bar">
                <div class="hp-inner"
                     th:style="'width:' + (${ai.currentHp} * 100 / ${ai.maxHp}) + '%'">
                </div>
            </div>
            <span th:text="${ai.currentHp}"></span> /
            <span th:text="${ai.maxHp}"></span>

            <!-- Poison -->
            <div th:if="${ai.poisonTurnsRemaining > 0}">
                <span class="poison-badge"
                      th:text="'Envenenado (' + ${ai.poisonDamagePerTurn} + ' por turno)'"></span>
            </div>
        </div>

    </div>

    <!-- SPRITES -->
    <div class="sprites">
        <img th:src="@{${player.backSpriteUrl}}"
            th:classappend="${player.currentHp == 0} ? 'fainted' : ''"
            style="cursor: pointer;"
            onclick="startSelectionMusic()">


        <img th:src="@{${ai.spriteUrl}}"
             th:classappend="${ai.currentHp == 0} ? 'fainted' : ''"
             style="margin-bottom: 30px;">
    </div>

    <!-- LOG + MOVES -->
    <div class="battle-bottom">

        <!-- LOG -->
        <div class="log-box">
            <div th:each="line : ${log}">
                <span th:text="${line}"></span><br>
            </div>
        </div>

        <!-- MOVES EM 2x2 -->
        <div class="moves">
            <div th:each="move, iter : ${player.moves}">
                <form th:action="@{|/battle/turn/${iter.index}|}" method="post">
                    <button class="move-btn"
                            type="submit"
                            th:disabled="${move.remainingUses == 0}"
                            th:title="${move.description}">
                        <span th:text="${move.name}"></span><br>
                        (<span th:text="${move.remainingUses}"></span> /
                        <span th:text="${move.maxUses}"></span>)
                    </button>
                </form>
            </div>
        </div>

    </div>

</div>

<!-- MÚSICA DA BATALHA -->
<audio id="battle-audio" src="/audio/batalhar.mp3" preload="auto" autoplay loop></audio>

<script>
    const battleMusic = document.getElementById("battle-audio");

    window.addEventListener("load", () => {
        battleMusic.volume = 0.6;
        battleMusic.play().catch(() => {
            // Caso o navegador bloqueie, libera após 1 clique
            document.body.addEventListener("click", () => battleMusic.play(), { once: true });
        });
    });
</script>


</body>
</html>
